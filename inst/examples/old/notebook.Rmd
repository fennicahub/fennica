---
title: 'Printing in a Periphery: a Quantitative Study of Finnish Knowledge Production, 1640-1828'
author: "Mikko Tolonen, Jani Marjanen, Hege Roivainen, Leo Lahti"
date: '`r Sys.Date()`'
output:
  word_document: default
  pdf_document: default
  html_notebook: default
---


```{r 201606krakow-init, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
# Default time span for the slides
min.year <- 1488
max.year <- 1828

library(stringr)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

library(fennica)
library(sorvi)
library(devtools)
# install_github("ropengov/gisfin")
# devtools::install_github('cttobin/ggthemr')
library(gisfin)
#library(ggthemr)

knitr::opts_chunk$set(echo = FALSE)
#knitr::opts_chunk$set(fig.path = "slides_201606_Krakow/", dev="CairoPNG")
knitr::opts_chunk$set(fig.path = "slides_201606_Krakow/")

# Set locale
tmp <- Sys.setlocale(locale="UTF-8") 

# Nice theme
theme_set(theme_bw(26))

# Nice default themes
# https://github.com/cttobin/ggthemr#palettes
#ggthemr('fresh', text_size = 20)
# ggthemr('greyscale', text_size = 20)
#ggthemr('light', text_size = 20)
# ggthemr('pale', text_size = 20)
#ggthemr_reset() # Reset theme
```


```{r 201606krakow-init2, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
# Full combined catalogue (Fen + Kun) with marked duplicates
df.combined.preprocessed <- readRDS("df.combined.Rds")
# Data with duplicates removed
df.full <- df.combined.preprocessed %>% filter(!remove)
# Data with years limited as well
df0 <- df.full %>% filter(publication_year >= min.year & publication_year <= max.year)
```

---

### TODO

sivu 3. Datamäärät koodista tähän takaisin. Deletoin tän vahingossa aikaisemmin kun koodi ei toiminut.

sivu 8. Karttakuvassa Greifswald, Lund ei näy. Tätä olisi hyvä saada kehitettyä, tällaisena tää ei ihan toimi.

sivu 12. Gävle-kuva vaihdettu Tukholmaan, pitää tsiigata mitkä vuodet highlightataan. Tällaisena ei vielä toimi. Onhan katalogi oikein?

sivu 27. Dissertation languages: kategoria "other" sisällön selvittäminen!

Yleisesti eri kuvien tekstit yms. tsekkaaminen, korostukset yms.

---

## From particular data to global perspective?

**Idea**: to study early modern knowledge production, all of it (1470-1830)

**How?** By combining library catalogues (Fennica, Kungliga, ESTC, CERL)

**Important**: to clean up the data (90% of the work!) and to take into account how particular data collections (Finnish National Bibliography, English Short-Title Catalogue etc.) have been formed.

**How to fail**: take worldcat or similar combination of datasets and analyse it as a whole without cleaning it up first.

---

[Intro]

### Data (1470-1828):

TÄHÄN DATA MÄÄRÄ KOODISTA!

### Method

- Open source tools for library catalogues (Github)

- Fully transparent and reproducible

- Scales up to new catalogues and tasks

- Benefit no. 1: once the work has been done, the data is available for everyone to use and to enrich. The generic data analytical ecosystem is designed with even unforeseen changes in mind.

---

[Intro]

### Context

- Finnish knowledge production 1640-1828 can only be understood in the Swedish context.

- Academy of Turku as part of the Swedish University system is the centre of Finnish knowledge production.

### Challenges: nationally delineated perspectives by using nationally collected materials

Overcoming a national gaze in the analysis by focusing on how knowledge production happened through a more complex network of cities.

---

### Outline of Quantitative Study of Finnish Knowledge Production, 1640-1828

1) General trends & political events

2) Publishers in Sweden and Turku

3) Languages & religious texts in Finland

4) University curriculum & Enlightenment in Finland

--> Visible roots of the diversity of "Finnishness" reflected in knowledge production, 1640-1828.

---

### 1. General trends & political events

---

[General trends & political events]

### Publishing activity in Swedish University Towns (Kungliga)

```{r map1, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=5}
library(dplyr)
library(ggmap)
library(ggplot2)
library(gisfin)
source("funcs.R")
theme_set(get_theme_map())
mapdata <- filter(df0,
          (catalog == "Kungliga" &
	      publication_place %in% c("Stockholm", "Uppsala",
	                         "Greifwald", "Lund", "Tartu"))|
	  (catalog == "Fennica" &
	      publication_place == "Turku")) %>%
      group_by(publication_decade, publication_place,
	       latitude, longitude) %>%
      summarise(n = n()) 

mapdata$size <- mapdata$n
mapdata$highlight <- rep("black", nrow(mapdata))
mapdata$highlight[mapdata$publication_place %in% c("Turku")] <- "red"
mapdata$highlight <- factor(mapdata$highlight)

region <- "Europe.north"
mymap <- get_map(location=geobox(region), color = "bw",
                  source="google",  maptype="terrain")

p0 <- ggmap(mymap) + theme(legend.position="none")

pics <- list()
for (i in c(1650, 1710, 1760, 1800)) {
  
    # Plot map
    p <- p0

    # Pick the investigated period (sliding window)
    # Sum up the years within this sliding window for each element    	    
    dfw <- subset(mapdata, publication_decade == i) %>%
    	     group_by(publication_place, latitude, longitude, highlight) %>%
		       summarize(n = sum(size))

    if (nrow(dfw) > 0) {
      p <- p0 +
      	geom_point(data = dfw,
      	  aes(x = longitude, y = latitude,
	      size = 20*log10(1+n),
	      color = highlight)) +
	      #color = highlight), alpha = 0.8) +	      
	  ggtitle(i) +
	  scale_size(range = c(2, 15)) +
	  theme(title = element_text(size = 30)) +
	  scale_color_manual(values = c("black", "red"))	  
    }
    
  pics[[as.character(i)]] <- p

}

library(gridExtra)
grid.arrange(pics[[1]], pics[[2]], pics[[3]], pics[[4]], nrow = 1)
#grid.arrange(pics[[1]], pics[[2]], pics[[3]], nrow = 1)
```


---

[General trends & political events]

### Fennica drop in 1700-1721, Kungliga peak in 1760-1770s, effect of Napoleonic wars (1803-1815)

```{r publishingovertime, echo=FALSE, message=FALSE, warning=FALSE, fig.width=6, fig.height=4, out.width="200px"}
df2 <- df0 %>% group_by(publication_decade, catalog) %>%
               summarise(n = n())
df2$highlight <- rep(FALSE, nrow(df2))
df2$highlight[df2$catalog == "Kungliga" &
	      df2$publication_decade %in% c(1770, 1810)] <- TRUE
df2$highlight[df2$catalog == "Fennica" &
	      df2$publication_decade %in% c(1710, 1810)] <- TRUE
v <- seq(1500, 1800, 50)
theme_set(theme_bw(20))
p <- ggplot(df2, aes(x = publication_decade, y = n)) +
     geom_line(aes(linetype = catalog), color = "black") +
     geom_point(aes(shape = catalog, color = highlight, size = highlight)) +
     ylab("Title count (n)") + xlab("Publication year") +
     scale_color_manual(values = c("darkgray", "black")) +
     theme(legend.position = "none") +
     scale_x_continuous(breaks = v, labels = v)
     # ggtitle("Overall publishing activity")
print(p)
```



---

[General trends & political events]

### Comparing publishing activity in Swedish University towns

Turku / Uppsala / Lund / Stockholm 

```{r publishingactivitycomparisons, echo=FALSE, message=FALSE, cache=TRUE, fig.width=6, fig.height=5, fig.show="hold", out.width="170px"}
v <- seq(1500, 1800, 50)
selected.places = c("Turku", "Uppsala", "Lund", "Stockholm")
df2 <- df0 %>% group_by(publication_decade, publication_place, catalog) %>%
               summarise(n = n()) %>%
	       filter(publication_place %in% selected.places) 
df2$catalog = factor(df2$catalog, levels = rev(c("Fennica", "Kungliga")))
df2$publication_place = droplevels(factor(df2$publication_place))
df3 = as.data.frame(spread(df2, publication_decade, n, fill = 0))
df2 = melt(df3)
colnames(df2) = c("publication_place", "catalog", "publication_decade", "n")
df2$publication_decade = as.numeric(as.character(df2$publication_decade))
df2$n = as.numeric(as.character(df2$n))
for (catal in unique(df2$catalog)) {
  p <- ggplot(subset(df2, catalog == catal), aes(x = publication_decade, y = n)) +
     geom_line(aes(linetype = publication_place)) +
     geom_point(aes(shape = publication_place), size = 3) +
     ylab("Title count (n)") + xlab("Publication year") +  
     ggtitle(catal) +
     scale_x_continuous(breaks = v, labels = v)     
  print(p)

}
```

---

[General trends & political events]

### Explaining the 1760-1770 publishing peak in Sweden

Role of pamphleteering in 1766-1774 plays a crucial role in the peak in publishing during the time of abolished censorship in Sweden.


```{r pamflets1, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=6, out.width="280px", fig.show="hold"}
df <- df0 %>%
        filter(catalog == "Kungliga")

# Add indicator of the publication period
df$period <- cut(df$publication_year,
           breaks = c(1757, 1766, 1775, 1783),
		 include.lowest = TRUE,
		 right = FALSE
		 )

# Remove entries outside the investigated publication periods
df <- df %>% filter(!is.na(period)) %>%
	     group_by(period) %>%
	     summarise(n = n(),
		  paper = sum(paper, na.rm = TRUE)) %>%
        mutate(paper.per.title = paper/n)		 

p <- ggplot(df,
       aes(x = period, y = paper.per.title)) + 
       geom_bar(stat = "identity") +
       scale_x_discrete(labels = c("1757-1765", "1766-1774", "1775-1783")) +
       ylab("Paper per title") + xlab("") 
print(p)
```

---

[General trends & political events]

### Stockholm & democratic cycles

An example how historical events, namely parliamentary assemblies in the Swedish case, have an impact on local knowledge production.

TODO: Vaihdettiin tähän Stockholm, riittää julkaisumäärät. Miksi katalogina lukee Fennica? Pitää olla Kungligan mukaan data tässä.

```{r riksdar2, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}
  myplace <- "Stockholm" # Norrköping / Stockholm
  minyear <- 1700
  maxyear <- 1800
  catalog <- "Kungliga"

  df <- df0
  df = subset(df, catalog == catal)
  df <- subset(df, publication_year >= minyear & publication_year <= maxyear)

  # Use timeinterval year intervals
  # Remove special chars
  if (length(unique(df$publication_place[grep("^G.vle$", df$publication_place)])) == 1) {
    df$publication_place[grep("^G.vle$", df$publication_place)] <- "Gavle"
  }
  if (length(unique(df$publication_place[grep("^Norrk.ping$", df$publication_place)])) == 1) {
    df$publication_place[grep("^Norrk.ping$", df$publication_place)] <- "Norrkoping"
  }
  df <- df %>% filter(publication_place == myplace)

  timeinterval <- 1
  df$timeunit <- round(df$publication_year/timeinterval)*timeinterval 

  df$unity = rep(1, nrow(df))
  publications <- tapply(df$unity, list(df$timeunit), sum)

  publications[is.na(publications)] <- 0 # Set NAs to 0
  publications <- publications/timeinterval # Instead of decadal sum, use average annual output 
library(reshape2)  
dfm <- melt(publications) 
  names(dfm) <- c("Time", "Documents")
  dfm <- transform(dfm, date = as.numeric(as.character(Time)))
  ymin = min(0.1)
  ymax = max(60)

  rect_left <- c(min(na.omit(dfm$date)),
               1719-.5, 1719+.5, # Stockholm 20 januari 1719 1 juni 1719
               1734-.5, 1734+.5, # Stockholm 14 maj 1734 14 december 1734
               1765-.5, 1766+.5, # Stockholm 21 februari 1765 21 oktober 1766
               1769-.5, 1770+.5, # Norrkoping & Stockholm 22 april 1769 5 februari 1770
               1771-.5, 1772+.5, # Stockholm 19 juni 1771 12 september 1772
               1792-.5, 1792+.5, # Gavle 26 januari 1792 24 februari 1792	       
               max(na.omit(dfm$date)))
  rectangles <- data.frame(
    xmin = rect_left[-length(rect_left)],
    xmax = rect_left[-1],
    ymin = ymin,
    ymax = ymax
    )
  rectangles$shade <- rep(c("White", "Highlight"), length = nrow(rectangles))

 riksplace = c("Stockholm", "Stockholm", "Stockholm", "Norrkoping", "Stockholm", "Gavle")
 cols = c("gray", "lightblue", "yellow", "white")
 rectangles$shade[rectangles$shade == "Highlight"] = riksplace
 rectangles$shade = factor(rectangles$shade)

  # Draw Figure
library(ggplot2)
  theme_set(theme_bw(20))
  p <- ggplot()
  p <- p + geom_rect(data = rectangles, 
	   aes(xmin=xmin, xmax=xmax,
	       ymin=ymin, ymax=ymax,
	       fill=shade), alpha=0.8) + 
         scale_fill_manual(values = cols) # + guides(fill = "none") 
  p <- p + geom_line(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + geom_point(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + ggtitle("Publishing activity")
  p <- p + ylab("Documents / Year")
  p <- p + xlab("Year")
  p <- p + ggtitle(paste(myplace, " (", catal, ")", sep = ""))
  print(p)
```

---

### 2. Publishers in Sweden and Turku

---

[Publishers in Sweden and Turku]

### Publishers in Swedish University towns (and Finland)

```{r publishers2-finland, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=7, fig.width=15}
df <- df0
df <- df %>%
        filter(catalog == "Fennica") %>%
	filter(country == "Finland" | publication_place == "Vyborg") %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Top publication places


top <- c("Turku", "Vaasa", "Vyborg")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.fennica <- npub


df <- df0
catalogue <- "Kungliga"
df <- df %>%
        filter(catalog == catalogue) %>%
        filter(publication_year >= 1640 & publication_year <= 1828)

# Selected publication places
top <- c("Stockholm", "Lund", "Uppsala", "Greifswald", "Tartu")
df <- df %>%	
        filter(publication_place %in% top) %>%	
        select(publication_decade, publication_place, publisher)
	
npub <- unique(df) %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.kungliga <- npub

npub <- bind_rows(npub.fennica, npub.kungliga)

# Order by total publishing activity
npub$publication_place <- factor(npub$publication_place, levels = (npub %>% group_by(publication_place) %>% summarise(total = sum(n)) %>% arrange(desc(total)))$publication_place)
npub <- npub %>% arrange(publication_place)


theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_decade, y = n)) +
       geom_bar(stat = "identity", position = "stack",
       		    aes(fill = publication_place)) + 
       xlab("Publication year") +
       ylab("Unique publishers (n)") +        
       ggtitle(paste("Unique publishers in selected publication places (", catalogue, ")"))


print(p)
```


---

[Publishers in Sweden and Turku]

### Turku in Sweden: proportions for title count and paper in Swedish University towns
 
```{r comparisons, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=20, fig.height=15}
pics <- list()
for (catalogue in na.omit(unique(df0$catalog))) {

df <- df0 %>% filter(catalog == catalogue)%>%
        filter(publication_year >= 1640 & publication_year <= 1828)
places <- c("Stockholm", "Uppsala", "Lund", "Greifswald", "Turku")
df$publication_place[!df$publication_place %in% places] <- "Other"
df <- subset(df, !is.na(df$publication_place))
#df$publication_place <- factor(df$publication_place, levels = c(places, "Other"))
library(reshape2)
library(magrittr)
library(tidyr)

df <- df %>% group_by(publication_decade, publication_place) %>%
             summarise(n = n(),
       	       paper = sum(paper, na.rm = TRUE),
		       publishers = length(na.omit(unique(publisher)))
		       )


# Calculate percentages
for (varname in c("n", "paper", "publishers")) {

  df$varname <- df[[varname]]
  dff <- df %>% select(publication_decade, publication_place, varname)
  dff <- spread(dff, publication_place, varname, fill = 0)
  dff[, -1] <- 100 * t(apply(dff[, -1], 1, function (x) {x/sum(x)}))
  dff <- melt(dff, "publication_decade");
  colnames(dff) <- c("publication_decade", "publication_place", "f")

  theme_set(theme_bw(20))
  p <- ggplot(dff, aes(x = publication_decade, y = f)) +
     geom_bar(position = "stack", stat = "identity",
       aes(fill = publication_place)) + 
     xlab("Publication year") +
     scale_fill_brewer(palette="Paired")
     if (varname == "n") {
       p <- p + ggtitle(paste("Title count (", catalogue, ")", sep = "")) + 
                ylab("Title count frequency (%)") 
     }
     if (varname == "paper") {
       p <- p + ggtitle(paste("Paper (", catalogue, ")", sep = "")) +
                ylab("Paper (%)")        
     }
     if (varname == "publishers") {
       p <- p + ggtitle(paste("Publishers (", catalogue, ")", sep = "")) +
                       ylab("Publishers (%)")
     }     


  pics[[paste(catalogue, varname, sep = "-")]] <- p

}
}
library(gridExtra)
grid.arrange(pics[[1]], pics[[2]], pics[[4]], pics[[5]], nrow = 2)
rm(pics)
```


---


[Publishers in Sweden and Turku]

### Title count of the output of publishers in Turku

```{r publishers4-fennica, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=7, fig.width=15}
place <- "Turku"
catalogue = "Fennica"
df = df0

df <- df %>%
        filter(catalog == catalogue & publication_place == place)

df <- df %>%	
  filter(publication_year >= 1640 & publication_year <= 1828)%>%
        select(publication_decade, publisher, paper)

# Group small publishers
# Top publishers by title count
ntop <- 10
top <- names(top(df, "publisher", ntop))
df$publisher[!df$publisher %in% top] <- "Other"
df$publisher <- factor(df$publisher, c(top, "Other"))

# Title count per decade & publisher	
npub <- df %>% group_by(publication_decade, publisher) %>% tally()

# TITLE COUNT
theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_decade, y = n)) +
       geom_bar(stat = "identity", position = "stack", aes(fill = publisher)) + 
       xlab("Publication year") +
       ylab("Title count (n)") +        
       ggtitle(paste("Title count per publisher (", place, "/", catalogue, ")", sep = ""))
print(p)
```

---

[Publishers in Sweden and Turku]

### Rock Bottom of the Great Northern War (1700-1721)

Publisher title count changes around 1700 with a nearly detrimental drop in Turku, significant publishing place in Finland at the time.

```{r drop1700B, echo=FALSE, message=FALSE, warning=FALSE, fig.width=15, fig.height=7}
# https://github.com/COMHIS/fennica/blob/master/inst/examples/figure_201606_Krakow/drop1700B-1.png

catalogue <- "Fennica"
place <- "Turku"

df <- df0
df <- df %>%
        filter(catalog == catalogue & publication_place == place) %>%
        filter(publication_year >= 1650 & publication_year < 1750)

# Selected ones
top <- names(top(df, "publisher", 5))
df$publisher[!df$publisher %in% top] <- "Other"
df$publisher <- factor(df$publisher, levels = c(top, "Other"))

# Publishing per year & publisher	
npub <- df %>%
     	  group_by(publication_year, publisher) %>%
	  summarize(paper = sum(paper, na.rm = TRUE), n = n())

theme_set(theme_bw(20))
p <- ggplot(npub, aes(x = publication_year, y = n, group = publisher)) +
       geom_point(size = 5, aes(shape = publisher, color = publisher)) +
       geom_smooth(col = "black", aes(shape = publisher, fill = publisher, color = publisher)) + 
       xlab("Publication year") +
       ylab("Title count (n)") +
       ylim(c(0, 1.1*max(npub$n))) +
       ggtitle(paste("Title count (", place, "/", catalogue, ")", sep = ""))
print(p)
```

---

### 3. Languages & religious texts in Finland

---

[Languages & religious texts in Finland]

### Different languages in Fennica and Kungliga (percentage)


```{r language-perc, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=12, out.width="150px", fig.show="hold"}
for (catalogue in c("Fennica", "Kungliga")) {

  if (catalogue == "Fennica") {
    df <- df.full # full time span
  } else if (catalogue == "Kungliga") {
    df <- df.full # full time span
  }
  langs <- c("Finnish", "Swedish", "Latin", "German", "Russian", "French", "Other")
  df <- df %>% filter(catalog == catalogue)%>%
        filter(publication_year >= 1600 & publication_year <= 1900)

  library(dplyr)
  library(tidyr)
library(magrittr)
library(reshape2)
  
lang <- paste("language.", langs, sep = "")
otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

dfl <- NULL
for (lan in lang) {

  # Classify a document to the specifed language
  # If document is assigned with languages, each case is considered
  # so one doc may have multiple entries corresponding to different languages
  # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
  # Combine data frames for specified languages
  dflsub <- filter(df, df[[lan]])
  if (nrow(dflsub)>0) {
    dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}

df <- dfl %>% group_by(publication_decade, language) %>%
     	     summarise(n = n())

# Calculate percentages
dff <- spread(df, language, n, fill = 0)
dff[, -1] <- 100 * t(apply(dff[, -1], 1, function (x) {x/sum(x)}))
dff <- melt(dff, "publication_decade");
colnames(dff) <- c("publication_decade", "language", "f")

theme_set(theme_bw(20))
p <- ggplot(dff, aes(x = publication_decade, y = f)) +
     geom_bar(position = "stack", stat = "identity", aes(fill = language)) + 
     xlab("Publication year") +
     ylab("Title count frequency (%)") +
     ggtitle(paste("Languages (", catalogue, ")", sep = "")) +
     scale_fill_brewer(palette="Paired")
print(p)
}
```

---


[Languages & religious texts in Finland]

### Development of use of different languages in Finnish National Bibliography

```{r language1, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8, out.width="160px", fig.show="hold"}
catalogue <- "Fennica"
df <- df0
langs <- c("Finnish", "Swedish", "Latin", "German", "Russian", "French", "Other")
lang <- paste("language.", langs, sep = "")
otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0
dfl <- NULL
for (lan in lang) {
  # Classify a document to the specifed language
  # If document is assigned with languages, each case is considered
  # so one doc may have multiple entries corresponding to different languages
  # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
  # Combine data frames for specified languages
  dflsub <- filter(df, df[[lan]])
  if (nrow(dflsub) > 0) {
    dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}

# ----------------------------------

df <- dfl %>% filter(catalog == catalogue)
df <- df %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
                 paper = sum(paper, na.rm = TRUE))

# TITLE COUNT
p <- ggplot(df, aes(x = publication_decade, y = n, group = language)) +
       geom_point(aes(col = language, shape = language), size = 5) +
       geom_line(aes(col = language, shape = language)) +       
       xlab("Publication year") +
       ylab("Title count (n)") +
       ggtitle(paste("Languages (", catalogue, ")", sep = ""))
print(p)


# PAPER CONSUMPTION
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(col = language, shape = language), size = 5) +
       geom_line(aes(col = language, shape = language)) +       
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Languages (", catalogue, ")", sep = ""))
print(p)
```

---

[Languages & religious texts in Finland]

### Different languages in Turku, Stockholm, Lund and Uppsala

```{r language-perc2, echo=FALSE, message=FALSE, warning=FALSE, fig.width=20, fig.height=15}
pics <- list()
theme_set(theme_bw(20))
myplaces <- c("Turku", "Greifswald", "Stockholm", "Uppsala", "Lund")

for (catalogue in c("Fennica", "Kungliga")) {

  df <- df0 %>% filter(catalog == catalogue) %>%
        filter(publication_year >= 1600 & publication_year <= 1828)

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {

    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }

  df <- dfl %>% group_by(publication_decade, publication_place, language) %>%
     	     summarise(n = n())

  # Calculate percentages
  dff <- spread(df, language, n, fill = 0)
  dff[, -c(1,2)] <- 100 * t(apply(dff[, -c(1,2)], 1, function (x) {x/sum(x)}))

  dff <- melt(dff, id = c("publication_place", "publication_decade"))
  colnames(dff) <- c("publication_place", "publication_decade", "language", "f")

  for (myplace in myplaces) {
    p <- ggplot(subset(dff, publication_place == myplace), aes(x = publication_decade, y = f)) +
      geom_bar(position = "stack", stat = "identity", aes(fill = language)) + 
      xlab("Publication year") +
      ylab("Title count frequency (%)") +
      ggtitle(paste("Languages (", myplace, "/", catalogue, ")", sep = "")) +
      scale_fill_brewer(palette="Paired")
    pics[[paste(catalogue, myplace, sep = "-")]] <- p
  }
}

grid.arrange(pics[[1]],
             pics[[8]], pics[[9]], pics[[10]], 
             nrow = 2)

rm(pics)
```

---

[Languages & religious texts in Finland]

### Topic diversity in different languages in Finnish publications

```{r topics232, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.show="hold"}
catalogue <- "Fennica"
df <- filter(df0, catalog == "Fennica") %>%
  filter(publication_year >= 1640 & publication_year <= 1828) %>%
  select(publication_year, language, subject_topic)
df <- unique(df)
df <- df %>% group_by(publication_year, language) %>%
             summarise(n = length(unique(unlist(strsplit(subject_topic, ";")))))

df$language[!df$language %in% langs] <- "Other"
df$language <- factor(df$language, levels = langs)

p <- ggplot(df, aes(x = publication_year, y = n, color = language)) +
       geom_line() + geom_point() +
       ggtitle("Number of subject topics")

print(p)
```

---

[Languages & religious texts in Finland]

### Devotional literature (catechisms, hymns, prayer collections, etc.) 

- Form of literature denoting the advancement of reading in Finland in the nineteenth century. It has been unclear when does it show up as a relevant category.

```{r topics12122, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.show="hold"}
# https://github.com/COMHIS/fennica/blob/master/inst/examples/figure_201606_Krakow/topics-2.png
sel <- c("virret","arkkiveisut","hartauskirjat","katekismukset","rukouspäivät","saarnat","aapiset","rukoukset","rukous","hengelliset laulut","hartauspuheet","virsikirjat")
catalogue <- "Fennica"

  # Selected catalogue with selected years
  df <- filter(df0, catalog == catalogue &
     		    publication_year >= 1640 &
		    publication_year <= 1828)

  # Selected topics
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
  df <- df %>% filter(catalog == catalogue & hit)

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0
  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }
  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

  # PAPER CONSUMPTION
  theme_set(theme_bw(20))
  p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(col = language, shape = language), size = 5) +
       geom_line(aes(col = language, shape = language)) +       
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Languages (", catalogue, ")", sep = "")) 
  print(p)
```

---

[Languages & religious texts in Finland]

### Temporary sermons in Latin and Swedish

- play an important role in early modern knowledge production. It has not been analysed in what language they were in Finland (and Sweden). 

```{r topics882, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
  sel <- c("hautajaiset", "häät", "juhlamenot")
  catalogue <- "Fennica"
  df <- df0
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  

  # Selected catalogue with selected topics
  df <- df %>% filter(catalog == catalogue & hit)
  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}
dfl$language <- factor(dfl$language, levels = langs)

  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

  # PAPER CONSUMPTION
  p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(col = language, shape = language), size = 5) +
       geom_line(aes(col = language, shape = language)) +       
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Languages (", catalogue, ")", sep = ""))
  print(p)
```

---

[Languages & religious texts in Finland]

### Combining devotional literature and temporary sermons

```{r topics3, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
sel <- c("virret","arkkiveisut","hartauskirjat","katekismukset","rukouspäivät","saarnat","aapiset","rukoukset","rukous","hengelliset laulut","hartauspuheet","virsikirjat","hautajaiset","häät","juhlamenot")
catalogue <- "Fennica"
  df <- df0 # selected time span
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  

  # Selected catalogue with selected topics
  df <- df %>% filter(catalog == catalogue & hit)

  # Selected catalogue with selected years
  df = filter(df0, catalog == catalogue & publication_year >= 1640 & publication_year <= 1828)

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0
  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
}

  # -------------------------------------------

  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

  # PAPER CONSUMPTION
  p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       #geom_point(aes(col = language, shape = language), size = 5) +
       #geom_line(aes(col = language, shape = language)) +
       geom_bar(stat = "identity", aes(fill = language, )) +              
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Languages (", catalogue, ")", sep = ""))
  print(p)
```

---

### 4. University curriculum & Enlightenment in Finland

---

[University curriculum & Enlightenment in Finland]

### Dissertation languages in Turku 1640-1828


```{r disslang, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
catalogue <- "Fennica"
langs <- c("Finnish", "Swedish", "Latin", "German",
           "Russian", "French", "Hebrew", "Other")

df <- df0 %>%
        filter(catalog == catalogue) %>%
        filter(publication_year >= 1640 & publication_year <= 1828) %>%
	filter(dissertation) 

lang <- paste("language.", langs, sep = "")
otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

dfl <- NULL
for (lan in lang) {

  # Classify a document to the specifed language
  # If document is assigned with languages, each case is considered
  # so one doc may have multiple entries corresponding to different languages
  # mean(rowSums(df[, lang]) == 1) # 93% Fennica docs have just 1 language
  # Combine data frames for specified languages
  dflsub <- filter(df, df[[lan]])
  if (nrow(dflsub)>0) {
    dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}

df <- dfl %>% group_by(publication_decade, language) %>%
     	     summarise(n = n())

# Calculate percentages
dff <- spread(df, language, n, fill = 0)
dff[, -1] <- 100 * t(apply(dff[, -1], 1, function (x) {x/sum(x)}))
dff <- melt(dff, "publication_decade");
colnames(dff) <- c("publication_decade", "language", "f")

# Order by language counts
dff$language <- factor(dff$language,
   levels = (df %>% group_by(language) %>%
                    summarise(total = sum(n)) %>%
		    arrange(total))$language);
dff <- dff %>% arrange(desc(language))

theme_set(theme_bw(20))
p <- ggplot(dff, aes(x = publication_decade, y = f)) +
     geom_bar(position = "stack", stat = "identity", aes(fill = language)) + 
     xlab("Publication year") +
     ylab("Title count frequency (%)") +
     ggtitle(paste("Languages (", catalogue, ")", sep = "")) +
     scale_fill_brewer(palette="Paired")
print(p)
```

---

[University curriculum & Enlightenment in Finland]

### Printing of philosophy in different languages in Turku

```{r topics-103, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
sel = c("filosofia","luonnonfilosofia","metafysiikka","logiikka")
# Selected catalogue with selected topics
df = dfl
df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
df <- df %>% filter(hit)
df <- df %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
                 paper = sum(paper, na.rm = TRUE))

# PAPER CONSUMPTION
theme_set(theme_bw(20))
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_bar(aes(fill = language), position = "stack", stat = "identity") +                     
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Paper (", paste(sel, collapse = ";"), ")", sep = ""))
print(p)

```


---

[University curriculum & Enlightenment in Finland]

### Printing of history in different languages in Turku

```{r topics-102, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
sel = c("oppihistoria","antiikki","historia")
# Selected catalogue with selected topics
df = dfl
df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
df <- df %>% filter(hit)
df <- df %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

# PAPER CONSUMPTION
theme_set(theme_bw(20))
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_bar(aes(fill = language), position = "stack", stat = "identity") +             
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Paper (", paste(sel, collapse = ";"), ")", sep = ""))
print(p)

```

---

[University curriculum & Enlightenment in Finland]

### Printing of economy and social science in different languages in Turku


```{r topics-105, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
sel =   c("psykologia","yhteiskuntafilosofia","valtiofilosofia","talous","raha","moraali","velvollisuudet","kasvatus","maanviljely","maatalous","kalastus")

# Selected catalogue with selected topics
df = dfl
df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
df <- df %>% filter(hit)
df <- df %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

# PAPER CONSUMPTION
theme_set(theme_bw(20))
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_bar(aes(fill = language), position = "stack", stat = "identity") +              
       xlab("Publication year") +
       ylab("Paper consumption") +
       ggtitle(paste("Paper (", paste(sel, collapse = ";"), ")", sep = ""))
print(p)

```

---

[University curriculum & Enlightenment in Finland]

### Rise of the octavo sized book as vehicle of Enlightenment

Paper consumption for different document formats over time. 

```{r LIBER-13, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.width=10, fig.height=8, fig.show="hold", out.width="150px"}
for (catal in unique(df0$catalog)) {
  df2 <- subset(df0, catalog == catal) %>% group_by(publication_decade, gatherings) %>% summarize(paper = sum(paper, na.rm = TRUE), n = n()) 
  df2 <- filter(df2, gatherings %in% setdiff(names(which(table(df2$gatherings) >= 15)), "NA"))
  df2$highlight <- rep("gray", nrow(df2))
  df2$highlight[df2$gatherings == "8vo"] <- "darkgreen"
    
  p <- ggplot(df2, aes(y = paper,
                       x = publication_decade,
  	       shape = gatherings,
		       linetype = gatherings))		       
  p <- p + geom_point(size = 4)
  p <- p + geom_smooth(method = "loess", size = 1,
         aes(color = highlight, fill = highlight))
  p <- p + scale_color_manual(values = c("darkgreen", "darkgray"))
  p <- p + scale_fill_manual(values = c("darkgreen", "darkgray"))  	 
  p <- p + ggtitle("Paper consumption in time by gatherings")
  p <- p + xlab("Year")
  p <- p + ylab("Paper consumption")
  p <- p + guides(linetype = guide_legend(keywidth = 5),
       	          shape = guide_legend(keywidth = 5))
  p <- p + ggtitle(paste("Paper consumption\n(", catal, ")", sep = ""))
  print(p)
}
```

---

[University curriculum & Enlightenment in Finland]

### Enlightenment literature read in Finland

```{r authors22, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=8, out.width="160px", fig.show="hold"}
theme_set(theme_bw(20))
for (catalogue in c("Fennica", "Kungliga")) {
  df <- filter(df0, catalog == catalogue) %>%
        filter(publication_year >= 1640 & publication_year <= 1828)
  top.authors <- names(comhis::top(df, field = "author", n = 10))
  dfs <- df %>% filter(author %in% top.authors) %>%
         group_by(author, publication_decade) %>%
         tally() %>%
         arrange(publication_decade)
  p <- ggplot(dfs, aes(x = publication_decade, y = n, fill = author)) +
       geom_bar(stat = "identity", position = "stack", color = "black") +
       xlab("Publication Decade") +
       ylab("Title Count") +
       scale_fill_grey() +
       guides(fill = guide_legend("Author")) +
       ggtitle(paste("Title count top authors\n", catalogue)) +
       xlim(c(1640, 1828))
  print(p)
}
```

---

### Thanks !

R master (plots & maps):
- Leo Lahti

Institutional support:

- Academy of Finland
- University of Helsinki
- Digitalia / The Regional Council of South Savo

Data providers:

- National Library of Finland
- National Library of Sweden

---

Extra Slide:

### Duplicate publications

```{r duplicates, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.height=5, fig.width=10}
# DUPLICATE FRACTION
df <- df.combined.preprocessed %>%
        filter(publication_year >= 1640 & publication_year <=1828) %>%
        group_by(catalog, publication_decade) %>%
	summarise(duplicates = 100 * mean(remove))
				   
p <- ggplot(df, aes(x = publication_decade, y = duplicates, fill = catalog)) +
       geom_bar(position = "dodge", stat = "identity") +
       ylab("Duplicates (%)") +
       scale_fill_manual(values = c("blue", "red")) + 
       ggtitle(paste("Duplicates", paste(range(na.omit(df$publication_decade)), collapse = "-"))) 

print(p)
```


