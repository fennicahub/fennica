---
title: "A Quantitative Approach to Book Printing in Sweden and Finland, 1640–1828"
author: "Mikko Tolonen, Leo Lahti, Hege Roivainen, Jani Marjanen (2018)"
date: "`r Sys.Date()`"
output: 
  beamer_presentation:
    theme: "boxes"
    colortheme: "orchid"
    fonttheme: "professionalfonts"
    dev: "pdf"
fontsize: 12pt
---

```{r init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
# Checking figure dimensions
# identify -format "%[fx:w/300] by %[fx:h/300] inches\n" Figure_1-1.eps
# Checking resolution
# identify -verbose Figure_1-1.eps

# Default time span
min.year <- 1640
max.year <- 1828
library(ggthemes)
library(ggmap)
library(gisfin)
library(stringr)
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

library(fennica)
library(sorvi)
library(devtools)

cities <- c(
	      "Lund",
	      "Other",
	      "Stockholm",
	      "Tartu",
	      "Turku",
	      "Uppsala",
	      "Vyborg",
	      "Gothenburg",
	      "Linköping",
	      "Greifswald"	      
	    )
city.colors <- stata_pal("s2color")(length(cities))
names(city.colors) <- cities
city.colors[["Other"]] <- "#696969"

languages <- c(
	      "Finnish",
	      "Other",
	      "Swedish",
	      "French",
	      "German",
	      "Hebrew",
	      "Latin",
	      "Russian"
	    )
lang.colors <- stata_pal("s2color")(length(city.colors))
names(lang.colors) <- languages
lang.colors[["Other"]] <- "#696969"
#lang.colors[["Hebrew"]] <- "#55752f"
#lang.colors[["Swedish"]] <- "#c10534"
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.path = "figures_HistoricalMethods2018/", dpi = 300)
knitr::opts_chunk$set(dev = "CairoPS")
knitr::opts_chunk$set(out.width = "17cm") # Default size 8.5cm ie 3.35 inch) per col
knitr::opts_chunk$set(out.format = "latex")
knitr::opts_chunk$set(fig.width=13.5,fig.height=8)

# Set locale
tmp <- Sys.setlocale(locale="UTF-8") 
```


```{r init2, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, cache=TRUE}
# Full combined catalogue (Fen + Kun) with marked duplicates
df.combined.preprocessed <- readRDS("df.combined.Rds")

# Data with duplicates removed
df.full <- df.combined.preprocessed %>% filter(!remove)
df.full <- df.full %>% mutate(Catalogue = catalog)

# Calculate title length (nchar and word count)
df.full$title_length_nchar <- nchar(df.full$title)
df.full$title_length_wordcount <- sapply(strsplit(df.full$title, " "), length)
df.full$title_length_wordcount[is.na(df.full$title)] <- NA

# Fix author names
df.full$author <- factor(gsub(" Von ", " von ", df.full$author))
df.full <- df.full %>% mutate(Topic = subject_topic) 

# Combine subcategories of gatherings
df.full$gatherings <- map_gatherings(df.full$gatherings, "Standard", "Short")

# Add primary language
df.full$language_primary <- sub(";.*", "", df.full$language)

# Change catalog name
df.full$Catalogue <- gsub("Fennica", "FNB", df.full$Catalogue)
df.full$Catalogue <- gsub("Kungliga", "SNB", df.full$Catalogue)
df.full$Catalogue <- factor(df.full$Catalogue)

# Data with years limited as well
df.full.1911 <- df.full %>% filter(publication_year >= min.year & publication_year <= 1911)
df0 <- df.full <- df.full %>% filter(publication_year >= min.year & publication_year <= max.year)
cols <- list(FNB = "blue", SNB = "darkred")
```

---
### Fig 1: Number of publication places over time

```{r Figure_1, message=FALSE, warning=FALSE, echo=FALSE}
library(dplyr)
library(ggplot2)
# theme_set(theme_bw(20))
#theme_set(theme_linedraw(20))
theme_set(theme_light(25))

df <- df0 %>% filter(publication_year >=1640 & publication_year <=1828) %>%
              group_by(Catalogue, publication_decade) %>%
	      summarise(n = length(unique(na.omit(publication_place))))

insert_minor <- function(major, n, start = NULL) {
  minor <- major
  ind <- ifelse (!is.null(start), which.min(abs(major - start)), 1)
  minor[-seq(ind, length(major), n)] <- ""
  minor
}

brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)

p <- ggplot(df, aes(x = publication_decade, y = n,
       color = Catalogue, shape = Catalogue)) + 
       geom_point(size = 4) + 
       geom_line(size = 1) + 
       ylab("Places (n)") +
       xlab("Decade") +
       # scale_color_manual(values = c("blue", "darkgreen")) +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 2)) + 
       guides(linetype = "none") +
       guides(shape = guide_legend(title = "Catalogue", reverse = TRUE),
              color = guide_legend(title = "Catalogue", reverse = TRUE)) +              
       #ggtitl("Unique publication places") +
       # ggtitle("Figure 1") +       
       scale_color_stata() +
       theme(axis.ticks.length=unit(3, "mm"), axis.ticks=element_line(size = 1))
 
print(p)
```

---


### Fig 2: Title count over time

```{r Figure_2, message=FALSE, warning=FALSE, echo=FALSE}
library(dplyr)
library(ggplot2)
df <- df0 %>% group_by(Catalogue, publication_decade) %>% tally()

brsy <- seq(0, 1e4, 2000)
p <- ggplot(df, aes(x = publication_decade, y = n,
                    shape = Catalogue,
		    color = Catalogue)) + 
       geom_point(size = 4) + 
       geom_line(size = 1) + 
       ylab("Title count (n)") +
       xlab("Decade") +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 2)) +
       scale_y_continuous(breaks = brsy, labels = brsy) +
       guides(
         shape = guide_legend(title = "Catalogue", reverse = TRUE),
         color = guide_legend(title = "Catalogue", reverse = TRUE)	 
       ) +
       scale_color_stata()
print(p)
```

---

### Fig 3: Rise of the Octavo

Paper consumption for various document formats over time.

```{r Figure_3prep, echo=FALSE, message=FALSE, warning=FALSE, echo=FALSE, fig.show="hide", results="hide", fig.width=27, fig.height=10}
library(scales)
scientific_10 <- function(x) {
  parse(text=gsub("\\+", "", gsub("e", " %*% 10^", scientific_format()(x))))
}

common.gatherings <- setdiff(names(which(table(df.full$gatherings) > 500)), "NA")

pics <- list()
for (catal in unique(df.full$Catalogue)) {

  # NOTE: IN FNB we show longer period
  if (catal == "SNB") {
    df00 <- df.full
  } else if (catal == "FNB") {
    df00 <- df.full.1911
  }

  df2 <- subset(df00, Catalogue == catal) %>%
           group_by(publication_decade, gatherings) %>%
	   summarize(paper = sum(paper, na.rm = TRUE), n = n())
  df2 <- filter(df2, gatherings %in% common.gatherings)  
  df2$highlight <- rep("Other", nrow(df2))
  df2$highlight[df2$gatherings == "8vo"] <- "Octavo"
  df2$gatherings <- factor(df2$gatherings, levels = levels(df.full$gatherings))

  brs <- seq(min(df2$publication_decade), max(df2$publication_decade), 10)  

  p <- ggplot(df2, aes(y = paper,
                       x = publication_decade,
  	       	       shape = gatherings,
		       linetype = gatherings
		       ))
		       
  p <- p + geom_point(size = 4) 

  p <- p + geom_smooth(method = "loess", size = 1,
         aes(color = highlight, fill = highlight))
	 
  p <- p + scale_fill_manual(values = c("darkgreen", "darkgray"))
  p <- p + scale_color_manual(values = c("darkgreen", "darkgray"))
  p <- p + xlab("Decade")
  p <- p + ylab("Paper (sheets)")
	 
  p <- p + guides(
       color = guide_legend(keywidth = 5, title = "Quires"),
        fill = guide_legend(keywidth = 5, title = "Quires"),     
       shape = guide_legend(keywidth = 5, title = "Quires", reverse = TRUE),
    linetype = guide_legend(keywidth = 5, title = "Quires", reverse = TRUE)) 

  p <- p + 
         scale_x_continuous(breaks = brs,
	   labels = insert_minor(brs, 5, start = ifelse(catal == "FNB", 1500, 1550))) + 
         scale_y_continuous(breaks = seq(0, 6.8, 1)*1e6, limits = c(0, 6.8)*1e6,
	                    label = scientific_10)

  pics[[catal]] <- p
}


library(cowplot)
# arrange the three plots in a single row
prow <- plot_grid(
           pics[[1]] + theme(legend.position="none"), #+ ylim(c(0, 7)),
           pics[[2]] + theme(legend.position="none"), #+ ylim(c(0, 7)),
           align = 'vh',
           labels = c("A", "B"),
	   label_size = 25,	   
           hjust = -1,
           nrow = 1
           )

# extract the legend from one of the plots
# (clearly the whole thing only makes sense if all plots
# have the same legend, so we can arbitrarily pick one.)
legend_b <- get_legend(pics[[1]] + theme(legend.position="right"))

# add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
p <- plot_grid( prow, legend_b, ncol = 2, rel_widths = c(1, .1))
```

```{r Figure_3, echo=FALSE, message=FALSE, warning=FALSE, fig.width=27, fig.height=10}
print(p)
```



---


### Fig 4: Median title length (word count)

```{r Figure_4, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, fig.show="last", fig.width=27, fig.height=10}
cols <- list(FNB = "blue", SNB = "darkred")

df <- df.full.1911 %>% 
              group_by(Catalogue, publication_year) %>%
              summarize(title_length = median(title_length_wordcount),
	      		n = n())

pics <- list()
brs <- seq(min(decade(df$publication_year)), max(decade(df$publication_year)), 10)
brsy <- seq(0, round(max(na.omit(df$title_length)), -1), 10)
for (catal in unique(df$Catalogue)) {
  pics[[catal]] <- ggplot(subset(df, Catalogue == catal),
       aes(x = publication_year, y = title_length)) +
       geom_point(aes(size = n)) +
       geom_smooth(color = cols[[catal]], fill = cols[[catal]]) +
       scale_x_continuous(breaks = brs,
         labels = insert_minor(brs, 5, start = century(min(brs)) + 50)) +
       scale_y_continuous(breaks = brsy,
         labels = insert_minor(brsy, 2),
	 limits = c(0, max(na.omit(df$title_length)))) +
       xlab("Decade") +
       ylab("Title length (words)")
}     

library(cowplot)
prow <- plot_grid(
           pics[[1]] + theme(legend.position="none"),
           pics[[2]] + theme(legend.position="none"),
           align = 'vh',
           labels = c("A", "B"),
	   label_size = 25,
           hjust = -1,
           nrow = 1
           )

# extract the legend from one of the plots
# (clearly the whole thing only makes sense if all plots
# have the same legend, so we can arbitrarily pick one.)
legend_b <- get_legend(pics[[1]] + theme(legend.position="right"))

# add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
p <- plot_grid( prow, legend_b, ncol = 2, rel_widths = c(.95, .08))
print(p)
```

---


### Fig 5: Turku as Swedish university town

Proportions for title count and paper in Swedish University towns
 
```{r Figure_5prep, echo=FALSE, message=FALSE, warning=FALSE, fig.width=27, fig.height=14, fig.show="none", results="hide"}
rm(p)
rm(prow)
rm(legend_b)
library(reshape2)
library(magrittr)
library(dplyr)
library(tidyr)

pics <- list()
places <- c("Stockholm", "Uppsala", "Lund", "Greifswald", "Tartu", "Turku")

for (cat in na.omit(unique(df0$Catalogue))) {

  df <- df0 %>% filter(Catalogue == cat)
  df <- subset(df, !is.na(df$publication_place))  
  df$publication_place[!df$publication_place %in% places] <- "Other"  
  df$publication_place <- factor(df$publication_place,
    levels = rev(c(setdiff(unique(df$publication_place), "Other"), "Other")))

  df <- df %>% group_by(publication_decade, publication_place) %>%
             summarise(n = n(),
                paper = sum(paper, na.rm = TRUE),
		publishers = length(na.omit(unique(publisher)))
		       )

  brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)

  # Calculate percentages
  for (varname in c("n", "paper", "publishers")) {

    df$varname <- df[[varname]]
    dff <- df %>% select(publication_decade, publication_place, varname)
    dff <- spread(dff, publication_place, varname, fill = 0)
    dff[, -1] <- 100 * t(apply(dff[, -1], 1, function (x) {x/sum(x)}))
    dff <- melt(dff, "publication_decade");
    colnames(dff) <- c("publication_decade", "publication_place", "f")

    # Theme_set(theme_bw(20))
    p <- ggplot(dff, aes(x = publication_decade, y = f)) +
      geom_bar(position = "stack", stat = "identity", color = "black",
       aes(fill = publication_place)) + 
       xlab("Decade") 

    if (varname == "n") {
       p <- p + labs(subtitle = paste("Title count (", cat, ")", sep = ""), y = "Title count (%)")
     }
     if (varname == "paper") {
       p <- p + labs(subtitle = paste("Paper (", cat, ")", sep = ""), y = "Paper (%)")
     }
     if (varname == "publishers") {
       p <- p + labs(subtitle = paste("Publishers (", cat, ")", sep = ""), y = "Publishers (%)")
     }     
  p <- p + scale_x_continuous(breaks = brs, labels = insert_minor(brs, 5, start = century(min(dff$publication_decade)) + 50))
  p <- p + scale_fill_manual(values = city.colors[as.character(levels(dff$publication_place))])
  p <- p + guides(fill = guide_legend(title = "")) 

  pics[[paste(cat, varname, sep = "-")]] <- p

}
}
library(gridExtra)

library(cowplot)
# arrange the three plots in a single row
prow <- plot_grid(
           pics[["FNB-n"]] + theme(legend.position="none"),
           pics[["FNB-paper"]] + theme(legend.position="none"),
           pics[["SNB-n"]] + theme(legend.position="none"),
           pics[["SNB-paper"]] + theme(legend.position="none"),
           align = 'vh',
           # labels = c("A", "B", "", ""),
	   # label_size = 25,	   
           hjust = -1,
           nrow = 2
           )

legend_b <- get_legend(pics[[1]] + theme(legend.position="right"))

# Add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
p2 <- plot_grid( prow, legend_b, ncol = 2, rel_widths = c(1, .1))
```

```{r Figure_5, echo=FALSE, message=FALSE, warning=FALSE, fig.width=27, fig.height=14}
theme_set(theme_bw(20))
print(p2)
rm(pics)
```

---

### Fig 6: Publishing activity over time (SNB)

```{r Figure_6, echo=FALSE, message=FALSE, warning=FALSE}
library(magrittr)
library(ggplot2)
library(dplyr)
v <- seq(1500, 1800, 100)
df <- df0 %>% filter(Catalogue == "SNB")

# Add indicator of the publication period
df$period <- cut(df$publication_year,
           breaks = c(1757, 1766, 1775, 1783),
		 include.lowest = TRUE,
		 right = FALSE
		 )
df$period <- format_period(df$period)

# Remove entries outside the investigated publication periods
df.all <- df %>% filter(!is.na(period)) %>%
	     group_by(period) %>%
	     summarise(n = n(),
		  paper = sum(paper, na.rm = TRUE)) %>%
        mutate(paper.per.title = paper/n)

# Remove entries outside the investigated publication periods
df.cities <- df %>% filter(!is.na(period)) %>%
	     group_by(period, publication_place) %>%
	     summarise(n = n(),
		  paper = sum(paper, na.rm = TRUE)) %>%
        mutate(paper.per.title = paper/n)		 

df.all$publication_place <- "All"
df <- bind_rows(df.all, df.cities) %>%
        filter(publication_place %in% c("Stockholm", "Uppsala", "Lund", "All"))

p <- ggplot(df,
       aes(fill = period, y = paper.per.title, x = publication_place)) + 
       geom_bar(stat = "identity", color = "black", position = "dodge") +
       scale_fill_stata() +
       guides(fill = guide_legend(title = "Period")) +
       ylab("Paper per title (sheets)") + xlab("") 

print(p)
```

---


### Fig 7: Publishing activity and riksdagar: SNB

```{r Figure_7, echo=FALSE, message=FALSE, warning=FALSE}
minyear <- 1700
maxyear <- 1830
catal <- "SNB"

library(magrittr)
library(ggplot2)
library(dplyr)
library(ggplot2)
library(reshape2)

  # Use timeinterval year intervals
  dfsel <- dplyr::filter(df0, Catalogue == catal)

  df <- df0
  df <- dplyr::filter(df, Catalogue == catal)
  df <- subset(df, publication_year >= minyear & publication_year <= maxyear)
  df <- subset(dfsel, publication_year >= minyear & publication_year <= maxyear)

  timeinterval <- 1
  df$timeunit <- round(df$publication_year/timeinterval) * timeinterval 

  df$unity <- rep(1, nrow(df))
  publications <- tapply(df$unity, list(df$timeunit), sum)

  publications[is.na(publications)] <- 0 # Set NAs to 0
  publications <- publications/timeinterval # Instead of decadal sum, use average annual output 
  dfm <- melt(publications) 
  names(dfm) <- c("Time", "Documents")
  dfm <- base::transform(dfm, date = as.numeric(as.character(Time)))
  ymin = min(dfm$Documents)
  ymax = max(dfm$Documents)

  rect_left <- c(min(na.omit(dfm$date)),
               1710-.5, 1710+.5, #
               1713-.5, 1714+.5, #
	       
               1719-.5, 1719+.5, # Stockholm 20 januari 1719 1 juni 1719
               1720-.5, 1720+.5, # Stockholm 20 januari 1719 1 juni 1719
               1723-.5, 1723+.5, # Stockholm 20 januari 1719 1 juni 1719

               1726-.5, 1727+.5, # Stockholm 20 januari 1719 1 juni 1719

               1731-.5, 1731+.5, # Stockholm 20 januari 1719 1 juni 1719	       	       
	       
               1734-.5, 1734+.5, # Stockholm 14 maj 1734 14 december 1734

               1738-.5, 1739+.5, #

               1740-.5, 1741+.5, #

               1742-.5, 1743+.5, #
               1746-.5, 1747+.5, #

               1751-.5, 1752+.5, #
               1755-.5, 1756+.5, #
               1760-.5, 1762+.5, #
	       
               1765-.5, 1766+.5, # Stockholm 21 februari 1765 21 oktober 1766
               1769-.5, 1770+.5, # Norrköping & Stockholm 22 april 1769 5 februari 1770
               1771-.5, 1772+.5, # Stockholm 19 juni 1771 12 september 1772

               1778-.5, 1779+.5, #
               1786-.5, 1786+.5, #
               1789-.5, 1789+.5, #

               1792-.5, 1792+.5, # Gävle 26 januari 1792 24 februari 1792

               1800-.5, 1800+.5, #
               1809-.5, 1810+.5, #
               1812-.5, 1812+.5, #
               1815-.5, 1815+.5, #
               1817-.5, 1818+.5, #
               1823-.5, 1823+.5, #
               1828-.5, 1830+.5, #

               max(na.omit(dfm$date)))
  rectangles <- data.frame(
    xmin = rect_left[-length(rect_left)],
    xmax = rect_left[-1],
    ymin = ymin,
    ymax = ymax
    )

  riksplace <- c(rep("Unknown", 2), "Stockholm", "Stockholm", "Stockholm", "Norrköping", "Stockholm", rep("Unknown", 3), "Gävle", rep("Unknown", 7))
  cols <- c("white", "lightgray", "darkgray")

  rectangles$shade <- rep(c("Background", "Highlight"), length = nrow(rectangles))
  rectangles$shade[rectangles$shade == "Background"] <- cols[[1]]
  rectangles$shade[rectangles$shade == "Highlight"] <- rep(cols[-1], length(which(rectangles$shade == "Highlight")))
  rectangles$shade <- factor(rectangles$shade, levels = cols)  

  rectangles$place <- rectangles$shade
  rectangles$place[rectangles$place == "Highlight"] <- riksplace
  rectangles$place[rectangles$place == "Background"] <- "" 

  brs <- seq(min(dfm$date), max(dfm$date), 10)
  brsy <- seq(0, round(max(dfm$Documents), -2), 250)

  # Draw Figure
  # theme_set(theme_bw(20))
  p <- ggplot() +
         geom_rect(data = rectangles, 
           aes(xmin=xmin, xmax=xmax,
	       ymin=ymin, ymax=ymax,
	       fill=shade), alpha=0.8) +
         scale_fill_manual(values = cols) +
	 guides(fill = "none")

  p <- p + geom_line(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + geom_point(data = dfm, aes(x = date, y = Documents), col = "black")
  p <- p + scale_x_continuous(breaks=brs, labels = insert_minor(brs, 2))
  p <- p + scale_y_continuous(breaks=brsy, labels = brsy)  
  p <- p + ylab("Title count (n)")
  p <- p + xlab("Year")

  print(p)
```

---


### Fig 8: Publishers in Swedish University towns (FNB)

Turku, Vaasa and Vyborg from FNB; Stockholm, Lund, Uppsala, Greifswald, Tartu from SNB.

```{r Figure_8, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
# Top publication places

df <- df0
catal <- "FNB"
df <- df %>%
        filter(Catalogue == catal) %>%
	filter(country == "Finland" | publication_place == "Vyborg") 

top <- c("Turku", "Vaasa", "Vyborg")
df <- filter(df, !is.na(publication_place))
df$publication_place[!df$publication_place %in% top] <- "Other"
top <- c(rev(top), "Other")
df <- df %>% select(publication_decade, publication_place)
df.fennica <- df

npub <- df %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.fennica <- npub

df <- df0
cat <- "SNB"
df <- df %>%
        filter(Catalogue == cat) %>%
        filter(country == "Sweden" | publication_place %in% c("Greifswald", "Tartu"))	

# Selected publication places
top <- c("Stockholm", "Lund", "Uppsala", "Greifswald")
df <- filter(df, !is.na(publication_place))
df$publication_place[!df$publication_place %in% top] <- "Other"
top <- c(top, "Other")
df <- df %>%	
        select(publication_decade, publication_place)
df.kungliga <- df

npub <- df %>% group_by(publication_decade, publication_place) %>% tally()
npub$publication_place <- factor(npub$publication_place, levels = top)
npub.kungliga <- npub

npub <- bind_rows(npub.fennica, npub.kungliga)

# Order by total publishing activity
npub$publication_place <- factor(npub$publication_place, levels = (npub %>%
                            group_by(publication_place) %>%
			    summarise(total = sum(n)) %>%
			    arrange(desc(total)))$publication_place)
npub <- npub %>% arrange(publication_place)
npub$publication_place <- factor(npub$publication_place,
         levels = rev(unique(npub$publication_place)))

rminds <- c()
for (dec in npub$publication_decade) {
  inds <- which(npub$publication_decade == dec &
            npub$publication_place == "Other")
  # Combine the counts for the other place
  if (length(inds) == 2) {
    npub[inds[[1]], "n"] <- sum(npub[inds,"n"])
    rminds <- c(rminds, inds[[2]])
  }
}
npub <- npub[-rminds, ]

npub$publication_place <- factor(npub$publication_place,
  levels = c("Other", setdiff(npub$publication_place, "Other")))

brs <- seq(min(npub$publication_decade), max(npub$publication_decade), 10)  
p <- ggplot(npub, aes(x = publication_decade, y = n)) +
       geom_bar(stat = "identity", position = "stack", color = "black",
       		    aes(fill = publication_place)) + 
       xlab("Decade") +
       ylab("Title count (n)") +
       scale_fill_manual(values = city.colors[as.character(levels(npub$publication_place))]) +        
       guides(fill = guide_legend(reverse = FALSE, title = "")) +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 2))
       
print(p)
```

---



### Fig 9: Publications in Vaasa in FNB, 1750-1828


```{r Figure_9, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
library(dplyr)
cat <- "FNB"
place <- "Vaasa"
minyear <- 1750
maxyear <- 1828

df <- df0 %>% filter(Catalogue == cat & publication_place == place) %>%	
        filter(publication_year >= minyear & publication_year <= maxyear) %>%
	group_by(publication_year) %>% 
	tally()

# Augment missing years with 0
missing.years <- setdiff(1750:1828, df$publication_year)
df <- rbind(df, data.frame(publication_year = missing.years,
  n = rep(0, length(missing.years))))
df <- df %>% arrange(publication_year)

brs <- seq(min(df$publication_year), max(df$publication_year), 1)

p <- ggplot(df, aes(x = publication_year, y = n)) +
     geom_point() +
     geom_line(size = 1) +     
     scale_x_continuous(breaks = brs,
       labels = insert_minor(brs, 10, start = 1770)) +
     xlab("Year") +
     ylab("Title count (n)") 

print(p)
```


---


### Fig 10: Top publishers in Turku/FNB

```{r Figure_10, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE}
library(dplyr)
place <- "Turku"
cat <- "FNB"
df <- df0

df <- df %>% filter(Catalogue == cat & publication_place == place) %>%
             filter(!is.na(publisher))


df <- df %>%	
        select(publication_decade, publication_year, publisher, paper) 

# Group small publishers
# Top publishers by title count
ntop <- 10
top <- names(top(df, "publisher", ntop))
df$publisher[!df$publisher %in% top] <- "Other"
df$publisher <- factor(df$publisher, c(top, "Other"))

# Title count per decade & publisher	
npub <- df %>% group_by(publication_decade, publisher) %>%
               tally() %>%
	       arrange(n)

# Title count per year & publisher	
npub0 <- df %>% group_by(publication_year, publisher) %>%
                tally() %>%
		arrange(n)

# Translate
npub$publisher <- gsub("ja poika", "and son", npub$publisher)
npub$publisher <- gsub("J.C. Frenckell and son", "Frenckell, Johan Christopher & Son", npub$publisher)
npub$publisher <- gsub("Frenckellin leski", "Frenckell's widow", npub$publisher)
npub$publisher <- gsub("Johan Christopher Frenckell's widow", "Frenckell, Johan Christopher's widow", npub$publisher)


# Translate
npub0$publisher <- gsub("ja poika", "and son", npub0$publisher)
npub0$publisher <- gsub("J.C. Frenckell and son", "Frenckell, Johan Christopher & Son", npub0$publisher)
npub0$publisher <- gsub("Frenckellin leski", "Frenckell's widow", npub0$publisher)
npub0$publisher <- gsub("Johan Christopher Frenckell's widow", "Frenckell, Johan Christopher's widow", npub0$publisher)

# Order by average publication year
ord <- as.character((npub0 %>% group_by(publisher) %>% 
                        summarise(year = mean(publication_year)) %>% 
                        arrange(year))$publisher)
npub$publisher <- factor(npub$publisher, levels = c("Other", setdiff(ord, "Other")))


# TITLE COUNT
brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
p <- ggplot(npub, aes(x = publication_decade, y = publisher)) +
      geom_point(aes(size = n)) +
      scale_x_continuous(breaks = brs, labels = insert_minor(brs, 5, start = century(min(brs)) + 50)) + 
      xlab("Decade") +
      ylab("") +
      guides(size = guide_legend(title = "Title count (n)")) 
      
print(p)
```

---



### Fig 11: Title count per capita

The historical population sizes used in this analysis are shown in this [table](https://github.com/COMHIS/fennica/blob/master/inst/extdata/population_sizes_in_cities.csv).

```{r Figure_11, echo=FALSE, message=FALSE, warning=FALSE}
# Read historical population sizes
f <- system.file("extdata/population_sizes_in_cities.csv", package = "fennica")
pop <- read.csv(f)
pop <- melt(pop, "Year")
colnames(pop) <- c("publication_decade", "publication_place", "population")
pop <- as_data_frame(pop)
pop$publication_place <- as.character(pop$publication_place)

# Cities with population data
cities <- setdiff(pop$publication_place, "Year")

# Take cities from SNB except Turku
cat <- "SNB"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	      filter(Catalogue == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())

# Take cities from FNB for Turku
cat <- "FNB"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	      filter(Catalogue == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())

df <- bind_rows(df1, df2)

# Remove special chars for compatibility (table join fails otherwise)
pop$publication_place <- gsub("Linköping", "Linkoping", pop$publication_place)
df$publication_place <- gsub("Linköping", "Linkoping", df$publication_place)

# Join title count and population size
dfm <- inner_join(pop, df, by = c("publication_decade", "publication_place"))

# Add title count per capita
dfm <- dfm %>% mutate(titles_per_capita = n/population)
dfm$publication_place <- gsub("Linkoping", "Linköping", dfm$publication_place)

brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
labs <- brs; labs[!brs %in% df$publication_decade] <- ""
p <- ggplot(dfm, aes(x = publication_decade, y = titles_per_capita)) +
       geom_line(aes(color = publication_place), size = 1) +
       geom_point(aes(shape = publication_place, color = publication_place), size = 5) +
       xlab("Decade") +
       ylab("Title count per capita (n)") +
       scale_color_manual(values = city.colors[match(unique(dfm$publication_place), names(city.colors))]) +              
       scale_x_continuous(breaks = brs, labels = labs) +
       guides(shape = guide_legend(title = "Place")) +
       guides(color = guide_legend(title = "Place")) 
print(p)
```

---



### Fig 12: Title count (absolute)

```{r Figure_12, echo=FALSE, message=FALSE, warning=FALSE}
# Take cities from SNB except Turku
cat <- "SNB"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	      filter(Catalogue == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())

# Take cities from FNB for Turku
cat <- "FNB"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	      filter(Catalogue == cat) %>%
              filter(publication_decade %in% pop$publication_decade) %>%
	      select(publication_decade, publication_place) %>%	      
	      group_by(publication_decade, publication_place) %>%
	      summarise(n = n())


df <- bind_rows(df1, df2)
brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
brsy <- seq(0, round(max(df$n), -3), 1e3)
labs <- brs; labs[!brs %in% df$publication_decade] <- ""

p <- ggplot(df, aes(x = publication_decade, y = n)) +
       geom_line(aes(color = publication_place), size = 1) +
       geom_point(aes(color = publication_place, shape = publication_place), size = 5) +
       xlab("Decade") +
       ylab("Title count (n)") +
       scale_x_continuous(breaks = brs, labels = labs) +
       scale_y_continuous(breaks = brsy, labels = insert_minor(brsy, 1)) +
       scale_color_manual(values = city.colors[match(unique(df$publication_place), names(city.colors))]) +       
       guides(shape = guide_legend(title = "Place")) +
       guides(color = guide_legend(title = "Place")) 

print(p)
```

---




### Fig 13: Octavo paper consumption

Paper consumption in octavo format books in Stockholm, Turku, Uppsala,
Lund, Göteborg and Linköping. Turku is from FNB, other cities from
SNB.

```{r Figure_13, echo=FALSE, message=FALSE, warning=FALSE}
# Take cities from SNB except Turku
cat <- "SNB"
df1 <- df0 %>% filter(publication_place %in% setdiff(cities, "Turku")) %>%
      	       filter(Catalogue == cat & gatherings == "8vo") %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE))

# Take cities from FNB for Turku
cat <- "FNB"
df2 <- df0 %>% filter(publication_place %in% "Turku") %>%
      	       filter(Catalogue == cat & gatherings == "8vo") %>%
	       group_by(publication_decade, publication_place) %>%
	       summarise(n = n(), paper = sum(paper, na.rm = TRUE))

df <- bind_rows(df1, df2)
brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
p <- ggplot(df, aes(x = publication_decade, y = paper)) +
       geom_line(aes(color = publication_place), size = 1) +
       geom_point(aes(color = publication_place, shape = publication_place), size = 5) +
       xlab("Decade") +
       ylab("Paper (sheets)") +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 5, start = century(min(brs)) + 50)) +
       scale_y_continuous(label = scientific_10) +
       scale_color_manual(values = city.colors[match(unique(df$publication_place), names(city.colors))]) +       
       guides(shape = guide_legend(title = "Place"), color = guide_legend(title = "Place")) 
print(p)
```


---


### Fig 14: Octavo title length (word count)

Average title length in words in Stockholm, Turku, Uppsala, Lund, Göteborg and Linköping. According to SNB, except Turku from FNB. 

```{r Figure_14, echo=FALSE, message=FALSE, warning=FALSE}
# Take cities from SNB except Turku
df00 <- df.full.1911 %>% filter(publication_year >= 1640 & publication_year <= 1850)
df1 <- df00 %>% filter((publication_place %in% setdiff(cities, "Turku") & Catalogue == "SNB") |
                       (publication_place %in% "Turku" & Catalogue == "FNB")) 
df1$publication_place[!df1$publication_place == "Stockholm"] <- "Other"
df1$publication_place <- droplevels(as.factor(as.character(df1$publication_place)))

df <- df1 %>% group_by(publication_decade, publication_place) %>%
  	       summarise(n = n(), paper = sum(paper, na.rm = TRUE), 
	       mean_title_length = mean(title_length_wordcount, na.rm = TRUE))

brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
p <- ggplot(df, aes(x = publication_decade, y = mean_title_length)) +
       geom_bar(color = "black",
         aes(fill = publication_place), position = "dodge", stat = "identity") +
       xlab("Decade") +
       ylab("Title length (words)") +
       scale_fill_manual(values = city.colors[as.character(levels(df$publication_place))]) +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 5, start = century(min(brs)) + 50)) +
       guides(fill = guide_legend(title = "Place", reverse = TRUE))        
print(p)
```

---


### Fig 15: Language use in Turku, Stockholm, Uppsala and Lund

```{r Figure_15prep, echo=FALSE, message=FALSE, warning=FALSE, fig.width=27, fig.height=15, fig.show="hide", results="hide"}
pics <- list()
myplaces <- c("Turku", "Greifswald", "Stockholm", "Uppsala", "Lund")
cnt <- 0
for (cat in c("FNB", "SNB")) {

  df <- df0 %>% filter(Catalogue == cat) 

  langs <- c("Finnish", "Swedish", "Latin", "German",
           "Russian", "French", "Hebrew", "Other")

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  otherlang <- otherlang[otherlang!="language.Multiple languages"]
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {

    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% FNB docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }

  df <- dfl %>% group_by(publication_decade, publication_place, language) %>%
     	     summarise(n = n())

  # Calculate percentages
  dff <- spread(df, language, n, fill = 0)
  dff[, -c(1,2)] <- 100 * t(apply(dff[, -c(1,2)], 1, function (x) {x/sum(x)}))
  dff <- melt(dff, id = c("publication_place", "publication_decade"))
  colnames(dff) <- c("publication_place", "publication_decade", "language", "f")
  dff$language <- factor(dff$language, levels = c("Other", setdiff(levels(dff$language), "Other")))

  for (myplace in myplaces) {

    dfss <- subset(dff, publication_place == myplace)
    brs <- seq(min(df.full$publication_decade),
               max(df.full$publication_decade), 10)  

    p <- ggplot(dfss,
      aes(x = publication_decade, y = f)) +
      geom_bar(position = "stack", stat = "identity",
      			aes(fill = language), color = "black") + 
      xlab("Decade") +
      ylab("Title count (%)")
      
      p <- p + labs(subtitle = paste(myplace, "/", cat)) +                 
      scale_fill_manual(values = lang.colors[as.character(levels(dfss$language))]) +      
      scale_x_continuous(breaks = brs,
                         labels = insert_minor(brs, 5),
                         limits = c(min.year, max.year)) +  
      guides(fill = guide_legend(title = "")) 
      pics[[paste(cat, myplace, sep = "-")]] <- p
  }
}

library(cowplot)
# arrange the three plots in a single row
prow <- plot_grid(
           pics[["FNB-Turku"]] + theme(legend.position="none"),
           pics[["SNB-Stockholm"]] + theme(legend.position="none"),
           pics[["SNB-Uppsala"]] + theme(legend.position="none"),
           pics[["SNB-Lund"]] + theme(legend.position="none"),	   	  
           align = 'vh',
           hjust = -1,
           nrow = 2
           )

legend_b <- get_legend(pics[[1]] + theme(legend.position="right"))

# add the legend underneath the row we made earlier. Give it 10% of the height
# of one plot (via rel_heights).
p <- plot_grid( prow, legend_b, ncol = 2, rel_widths = c(1, .1))
rm(pics)
```


```{r Figure_15, echo=FALSE, message=FALSE, warning=FALSE, fig.width=27, fig.height=15}
print(p)
```

---


### Fig 16: Topic richness per language (FNB)

```{r Figure_16, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold"}
cat <- "FNB"
df <- filter(df0, Catalogue == cat) %>%
  select(publication_decade, language, subject_topic)
df <- unique(df)
df <- df %>% group_by(publication_decade, language) %>%
             summarise(n = length(unique(unlist(strsplit(subject_topic, ";")))))

langs2 <- c("Finnish", "Swedish", "Latin", "Other")
df$language[!df$language %in% langs2] <- "Other"
df$language <- factor(df$language, levels = langs2)

brs <- seq(min(decade(df$publication_decade)), max(decade(df$publication_decade)), 10)
p <- ggplot(df, aes(x = publication_decade, y = n, shape = language)) +
       geom_line(size = 1, aes(color = language)) +
       geom_point(size = 4, aes(color = language)) +
       scale_color_brewer(palette="Greys") +
       scale_fill_brewer(palette="Greys") +
       guides(shape = guide_legend(title = "Language"),
              color = guide_legend(title = "Language")) +
       scale_color_manual(values = lang.colors[as.character(levels(df$language))]) +             
       scale_x_continuous(breaks = brs,
                          labels = insert_minor(brs, 2,
			  start = century(min(brs)) + 40)) +                 
       ylab("Topical terms (n)") +
       xlab("Decade") 

print(p)
```

---


### Fig 17: Temporary sermons in Latin and Swedish

```{r Figure_17, echo=FALSE, message=FALSE, warning=FALSE}
sel <- c("hautajaiset", "häät", "juhlamenot")
Catalogue <- NULL
cat <- "FNB"
df <- df0
df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)

# Selected Catalogue with selected topics
df <- df %>% filter(Catalogue == cat & hit)
  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  otherlang <- otherlang[otherlang!="language.Multiple languages"]
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0

  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% FNB docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
    dfl <- bind_rows(dfl, dflsub)
  }
}
dfl$language <- factor(dfl$language, levels = langs)

  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

  brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
  
  # PAPER CONSUMPTION
  p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(shape = language, color = language), size = 5) +
        geom_line(aes(color = language), size = 1) +       
       xlab("Decade") +
       ylab("Paper (sheets)") +
       guides(shape = guide_legend(title = "Language"),
              color = guide_legend(title = "Language")) +
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 2, start = 1600)) +
       scale_y_continuous(label = scientific_10) + 
       scale_color_manual(values = lang.colors[as.character(levels(df$language))]) 
print(p)
```

---


### Fig 18: Devotional literature (catechisms, hymns, prayers, etc.) 

Form of literature denoting the advancement of reading in Finland in the 19th century. It has been unclear when devotional literature  shows up as a relevant category.

```{r Figure_18, echo=FALSE, message=FALSE, warning=FALSE, fig.show="hold"}
sel <- c("virret","arkkiveisut","hartauskirjat","katekismukset","rukouspäivät","saarnat","aapiset","rukoukset","rukous","hengelliset laulut","hartauspuheet","virsikirjat")
Catalogue <- NULL
cat <- "FNB"

  # Selected Catalogue with selected years
  df <- filter(df0, Catalogue == cat)

  # Selected topics
  df$hit <- apply((sapply(sel, function (x) {grepl(x, tolower(df$subject_topic))})), 1, any)  
  df <- df %>% filter(Catalogue == cat & hit)

  lang <- paste("language.", langs, sep = "")
  otherlang <- setdiff(names(df)[grep("lang.", names(df))], lang)
  df$language.Other <- rowSums(df[, otherlang] == TRUE, na.rm = T) > 0
  dfl <- NULL
  for (lan in lang) {
    # Classify a document to the specifed language
    # If document is assigned with languages, each case is considered
    # so one doc may have multiple entries corresponding to different languages
    # mean(rowSums(df[, lang]) == 1) # 93% FNB docs have just 1 language
    # Combine data frames for specified languages
    dflsub <- filter(df, df[[lan]])
    if (nrow(dflsub) > 0) {
      dflsub$language <- gsub("language.", "", lan)
      dfl <- bind_rows(dfl, dflsub)
    }
  }
  df <- dfl %>% group_by(publication_decade, language) %>%
             summarise(n = n(),
	               paper = sum(paper, na.rm = TRUE))

# PAPER CONSUMPTION
brs <- seq(min(df$publication_decade), max(df$publication_decade), 10)
p <- ggplot(df, aes(x = publication_decade, y = paper, group = language)) +
       geom_point(aes(shape = language, color = language), size = 5) +
       geom_line(aes(color = language), size = 1) +       
       xlab("Decade") +
       ylab("Paper (sheets)") +
       guides(shape = guide_legend(title = "Language"),
         color = guide_legend(title = "Language")) +
       scale_color_manual(values = lang.colors[match(unique(df$language),
         names(lang.colors))]) +              
       scale_x_continuous(breaks = brs, labels = insert_minor(brs, 2)) +       
       scale_y_continuous(label = scientific_10) 

print(p)
```

---



## Session info

This document was created with the following versions:

```{r sessioninfo, message=FALSE, warning=FALSE}
sessionInfo()
```





